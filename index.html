<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniSENAC - Monitor ESP32C3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script>
        function aguardarLibraryMQTT() {
            return new Promise((resolve, reject) => {
                let tentativas = 0;
                const verificarLibrary = () => {
                    tentativas++;
                    if (typeof Paho !== 'undefined' && typeof Paho.MQTT !== 'undefined') {
                        window.MQTTClient = Paho.MQTT.Client;
                        resolve('Paho.MQTT');
                    } else if (typeof Paho !== 'undefined' && typeof Paho.Client !== 'undefined') {
                        window.MQTTClient = Paho.Client;
                        resolve('Paho.Client');
                    } else if (tentativas < 50) {
                        setTimeout(verificarLibrary, 100);
                    } else {
                        reject('Timeout ao carregar biblioteca MQTT');
                    }
                };
                verificarLibrary();
            });
        }
    </script>
    <style>
        :root {
            --primary: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --bg-dark: #0d1117;
            --bg-medium: #161b22;
            --bg-light: #21262d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --border: #30363d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 25px;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 2.4em;
        }
        
        h2 {
            color: #f0883e;
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        h3 {
            color: var(--text-muted);
            margin: 20px 0 15px 0;
            font-size: 1.4em;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .status-card {
            background-color: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }
        
        .status-line {
            display: flex;
            margin: 12px 0;
            align-items: center;
        }
        
        .status-label {
            min-width: 180px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .status-value {
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.95em;
        }
        
        .online {
            color: var(--success);
            background-color: rgba(63, 185, 80, 0.1);
        }
        
        .offline {
            color: var(--danger);
            background-color: rgba(248, 81, 73, 0.1);
        }
        
        .waiting {
            color: var(--warning);
            background-color: rgba(210, 153, 34, 0.1);
        }
        
        .button-visual {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 25px auto;
            background: linear-gradient(145deg, #1a1f29, #232a37);
            box-shadow: 8px 8px 16px #0a0d12, -8px -8px 16px #242a36;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .button-visual.pressed {
            box-shadow: inset 6px 6px 12px #0a0d12, inset -6px -6px 12px #242a36;
        }
        
        .button-visual.pressed::after {
            content: '';
            position: absolute;
            width: 80%;
            height: 80%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(63, 185, 80, 0.3) 0%, rgba(63, 185, 80, 0.1) 70%);
        }
        
        .button-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--success);
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .button-visual.pressed .button-indicator {
            opacity: 1;
            box-shadow: 0 0 20px var(--success);
        }
        
        .button-label {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1em;
            color: var(--text-muted);
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .info-item {
            background-color: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .info-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 5px 0;
            color: var(--primary);
        }
        
        .info-label {
            font-size: 0.9em;
            color: var(--text-muted);
        }
        
        .rssi-excellent { color: var(--success); }
        .rssi-good { color: #a5d6a7; }
        .rssi-fair { color: var(--warning); }
        .rssi-weak { color: var(--danger); }
        
        .log-container {
            background-color: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            height: 250px;
            overflow-y: auto;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .log-time {
            color: var(--primary);
            margin-right: 10px;
        }
        
        .heartbeat-status {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: var(--bg-light);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .heartbeat-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        .heartbeat-active {
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: heartbeat-pulse 2s infinite;
        }
        
        .heartbeat-inactive {
            background-color: var(--danger);
        }
        
        @keyframes heartbeat-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--bg-dark);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .progress-low { background-color: var(--success); }
        .progress-medium { background-color: var(--warning); }
        .progress-high { background-color: var(--danger); }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.95em;
        }
        
        .blink {
            animation: blink-animation 1.5s steps(2, start) infinite;
        }
        
        @keyframes blink-animation {
            to {
                opacity: 0.5;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .system-info {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>UniSENAC Pelotas - IoT</h1>
            <h2>Monitor ESP32C3 / Heartbeat</h2>
        </header>
        
        <div class="dashboard">
            <div class="status-card">
                <h3>Status do Sistema</h3>
                
                <div class="status-line">
                    <div class="status-label">Conexão MQTT:</div>
                    <div id="mqttStatus" class="status-value waiting blink">Conectando...</div>
                    <button id="reconnectBtn" onclick="forceReconnect()" style="margin-left: 10px; padding: 5px 10px; background: #0969da; color: white; border: none; border-radius: 4px; cursor: pointer;">Reconectar</button>
                </div>
                
                <div class="status-line">
                    <div class="status-label">Status do Botão:</div>
                    <div id="buttonStatus" class="status-value waiting">Aguardando...</div>
                </div>
                
                <div class="status-line">
                    <div class="status-label">Última Atualização:</div>
                    <div id="lastUpdate" class="status-value">--:--:--</div>
                </div>
                
                <div class="heartbeat-status">
                    <div id="heartbeatIndicator" class="heartbeat-indicator heartbeat-inactive"></div>
                    <div>Heartbeat: <span id="heartbeatText">Aguardando primeiro heartbeat (batimento)...</span></div>
                </div>
            </div>
            
            <div class="status-card" style="text-align: center;">
                <h3>Visualização do Botão</h3>
                <div id="buttonVisual" class="button-visual">
                    <div class="button-indicator"></div>
                </div>
                <div class="button-label">Botão do ESP32C3</div>
                
                <div class="status-line" style="justify-content: center; margin-top: 20px;">
                    <div class="status-label">Mensagens Recebidas:</div>
                    <div id="messageCount" class="status-value">0</div>
                </div>
                
                <div class="status-line" style="justify-content: center;">
                    <div class="status-label">Contador Heartbeat:</div>
                    <div id="heartbeatCount" class="status-value">0</div>
                </div>
            </div>
        </div>
        
        <h3>Informações do Sistema ESP32</h3>
        <div class="system-info">
            <div class="info-item">
                <div class="info-label">Sinal WiFi (RSSI)</div>
                <div id="rssiValue" class="info-value">-- dBm</div>
                <div id="rssiQuality" class="info-label">Qualidade: --</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Tensão de Alimentação</div>
                <div id="voltageValue" class="info-value">-- V</div>
                <div class="info-label">Tensão</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Memória Livre</div>
                <div id="memoryFree" class="info-value">-- KB</div>
                <div class="info-label">de <span id="memoryTotal">-- KB</span> total</div>
                <div class="progress-bar">
                    <div id="memoryUsageBar" class="progress-fill progress-low"></div>
                </div>
                <div class="info-label"><span id="memoryUsage">--</span>% utilizada</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Tempo de Atividade</div>
                <div id="uptimeValue" class="info-value">--</div>
                <div class="info-label">segundos</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">Endereço IP</div>
                <div id="ipAddress" class="info-value">--.--.--.--</div>
                <div class="info-label">IP do ESP32</div>
            </div>
        </div>
        
        <h3>Log de Eventos</h3>
        <div id="eventLog" class="log-container">
            <div class="log-entry">
                <span class="log-time" id="currentTime">--:--:--</span>
                <span>Sistema inicializado. Aguardando heartbeat do ESP32...</span>
            </div>
        </div>
        
        <footer>
            <p>UniSENAC Pelotas - Sistema de Monitoramento IoT - Desenvolvido para o ESP32C3</p>
            <p>Client ID: <span id="clientId">--</span></p>
        </footer>
    </div>

    <script>
        const statusMqtt = document.getElementById('mqttStatus');
        const statusBotao = document.getElementById('buttonStatus');
        const ultimaAtualizacao = document.getElementById('lastUpdate');
        const visualBotao = document.getElementById('buttonVisual');
        const logEventos = document.getElementById('eventLog');
        const elementoIdCliente = document.getElementById('clientId');
        const elementoContadorMensagens = document.getElementById('messageCount');
        const elementoContadorBatimentos = document.getElementById('heartbeatCount');
        const elementoHoraAtual = document.getElementById('currentTime');
        const indicadorBatimentos = document.getElementById('heartbeatIndicator');
        const textoBatimentos = document.getElementById('heartbeatText');
        
        const valorRssi = document.getElementById('rssiValue');
        const qualidadeRssi = document.getElementById('rssiQuality');
        const valorVoltagem = document.getElementById('voltageValue');
        const memoriaLivre = document.getElementById('memoryFree');
        const memoriaTotal = document.getElementById('memoryTotal');
        const usoMemoria = document.getElementById('memoryUsage');
        const barraUsoMemoria = document.getElementById('memoryUsageBar');
        const valorUptime = document.getElementById('uptimeValue');
        const enderecoIp = document.getElementById('ipAddress');

        let contadorMensagens = 0;
        let contadorBatimentos = 0;
        let cliente;
        let conectado = false;
        let tempoUltimoBatimento = 0;
        let intervaloBatimentos;
        let tentativasBroker = 0;

        const configsBroker = [
            { host: "test.mosquitto.org", port: 8081, useSSL: true, path: "/" }
        ];

        const idCliente = 'unisena_web_' + Math.random().toString(16).substr(2, 8);
        elementoIdCliente.textContent = idCliente;

        function atualizarRelogio() {
            const agora = new Date();
            const textoHora = agora.toLocaleTimeString();
            elementoHoraAtual.textContent = textoHora;
            
            if (tempoUltimoBatimento > 0) {
                const segundosDesde = Math.floor((Date.now() - tempoUltimoBatimento) / 1000);
                
                if (segundosDesde > 20) {
                    indicadorBatimentos.className = 'heartbeat-indicator heartbeat-inactive';
                    textoBatimentos.textContent = `Inativo - ${segundosDesde}s sem resposta`;
                    textoBatimentos.style.color = '#f85149';
                } else if (segundosDesde > 15) {
                    textoBatimentos.textContent = `Atrasado - ${segundosDesde}s desde último`;
                    textoBatimentos.style.color = '#d29922';
                }
            }
        }
        
        setInterval(atualizarRelogio, 1000);
        atualizarRelogio();

        function adicionarEntradaLog(mensagem) {
            const agora = new Date();
            const textoHora = agora.toLocaleTimeString();
            
            const entradaLog = document.createElement('div');
            entradaLog.className = 'log-entry';
            entradaLog.innerHTML = `<span class="log-time">${textoHora}</span> <span>${mensagem}</span>`;
            
            logEventos.appendChild(entradaLog);
            logEventos.scrollTop = logEventos.scrollHeight;
        }

        // Sinal WiFi / RSSI
        function obterQualidadeWifi(rssi) {
            if (rssi >= -50) return { text: "Excelente", class: "rssi-excellent" };
            if (rssi >= -60) return { text: "Bom", class: "rssi-good" };
            if (rssi >= -70) return { text: "Moderado", class: "rssi-fair" };
            return { text: "Fraco", class: "rssi-weak" };
        }

        // Uso de memória
        function obterClasseUsoMemoria(uso) {
            if (uso < 50) return "progress-low";
            if (uso < 75) return "progress-medium";
            return "progress-high";
        }

        // Heartbeat recebido
        function processarBatimento(dados, timestamp) {
            try {
                const data = JSON.parse(dados);
                
                if (data.type === "heartbeat") {
                    tempoUltimoBatimento = Date.now();
                    contadorBatimentos++;
                    elementoContadorBatimentos.textContent = contadorBatimentos;
                    
                    indicadorBatimentos.className = 'heartbeat-indicator heartbeat-active';
                    textoBatimentos.textContent = `Ativo - Contador: ${contadorBatimentos}`;
                    textoBatimentos.style.color = '#3fb950';
                    
                    adicionarEntradaLog(`💗 [${timestamp}] Heartbeat #${data.counter} recebido do ESP32`);
                    
                    if (data.rssi !== undefined) {
                        valorRssi.textContent = `${data.rssi}`;
                        const qualidade = obterQualidadeWifi(data.rssi);
                        qualidadeRssi.textContent = `Qualidade: ${qualidade.text}`;
                        qualidadeRssi.className = `info-label ${qualidade.class}`;
                    }
                    
                    if (data.voltage !== undefined) {
                        valorVoltagem.textContent = data.voltage.toFixed(2);
                    }
                    
                    if (data.free_memory !== undefined && data.total_memory !== undefined) {
                        memoriaLivre.textContent = Math.round(data.free_memory / 1024);
                        memoriaTotal.textContent = Math.round(data.total_memory / 1024);
                        const uso = ((data.total_memory - data.free_memory) / data.total_memory) * 100;
                        usoMemoria.textContent = uso.toFixed(1);
                        barraUsoMemoria.style.width = uso + '%';
                        barraUsoMemoria.className = `progress-fill ${obterClasseUsoMemoria(uso)}`;
                    }
                    
                    if (data.uptime !== undefined) {
                        valorUptime.textContent = data.uptime;
                    }
                    
                    if (data.ip !== undefined) {
                        enderecoIp.textContent = data.ip;
                    }
                }
            } catch (e) {
                adicionarEntradaLog(`⚠️ [${timestamp}] Erro ao processar heartbeat: ${e.message}`);
                console.error('Erro no processamento do heartbeat:', e);
            }
        }

// Inicializar MQTT
function iniciarMqtt() {
    if (tentativasBroker >= configsBroker.length) {
        adicionarEntradaLog('❌ Falha na conexão. Tentando novamente em 10 segundos...');
        setTimeout(() => {
            tentativasBroker = 0;
            iniciarMqtt();
        }, 10000);
        return;
    }

    const config = configsBroker[tentativasBroker];
    adicionarEntradaLog(`🔄 Conectando a ${config.host}:${config.port}...`);
    
    try {
        cliente = new window.MQTTClient(
            config.host,
            config.port,
            config.path,
            idCliente
        );

        cliente.onConnectionLost = aoPerderConexao;
        cliente.onMessageArrived = aoReceberMensagem;

        const opcoes = {
            useSSL: config.useSSL,
            timeout: 15,
            onSuccess: aoConectar,
            onFailure: aoFalhar,
            keepAliveInterval: 30,
            cleanSession: true
        };

        statusMqtt.textContent = 'Conectando...';
        statusMqtt.className = 'status-value blink';
        
        cliente.connect(opcoes);
        
    } catch (error) {
        adicionarEntradaLog(`💥 Erro: ${error.message}`);
        tentativasBroker++;
        setTimeout(() => iniciarMqtt(), 2000);
    }
}

        function aoConectar() {
            conectado = true;
            const config = configsBroker[tentativasBroker];
            statusMqtt.classList.remove('blink');
            adicionarEntradaLog(`✅ Conectado ao ${config.host}:${config.port}`);
            statusMqtt.textContent = 'Conectado';
            statusMqtt.className = 'status-value online';
            
            cliente.subscribe("esp32/status/unisenac");
            cliente.subscribe("esp32/heartbeat/unisenac");
            adicionarEntradaLog('📡 Aguardando mensagens do ESP32...');
        }

        function aoFalhar(erro) {
            adicionarEntradaLog(`❌ Falha: ${erro.errorMessage}`);
            tentativasBroker++;
            setTimeout(() => iniciarMqtt(), 2000);
        }

        function aoPerderConexao(respostaObjeto) {
            if (respostaObjeto.errorCode !== 0) {
                conectado = false;
                adicionarEntradaLog(`Conexão perdida: ${respostaObjeto.errorMessage}`);
                statusMqtt.textContent = 'Desconectado';
                statusMqtt.className = 'status-value offline';
            }
        }

        function aoReceberMensagem(mensagem) {
            contadorMensagens++;
            elementoContadorMensagens.textContent = contadorMensagens;
            
            const topico = mensagem.destinationName;
            const dados = mensagem.payloadString;
            const agora = new Date();
            const timestamp = agora.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            if (topico === "esp32/status/unisenac") {
                try {
                    const data = JSON.parse(dados);
                    
                    ultimaAtualizacao.textContent = timestamp;
                    
                    if (data.button !== undefined) {
                        const botaoPressionado = data.button === 1;
                        statusBotao.textContent = botaoPressionado ? 'LOW' : 'HIGH';
                        statusBotao.className = botaoPressionado ? 'status-value online' : 'status-value offline';
                        
                        if (botaoPressionado) {
                            visualBotao.classList.add('pressed');
                            adicionarEntradaLog(`🔘 [${timestamp}] BOTÃO LOW - ESP32 Uptime: ${data.uptime}s`);
                        } else {
                            visualBotao.classList.remove('pressed');
                            adicionarEntradaLog(`⚪ [${timestamp}] BOTÃO HIGH - ESP32 Uptime: ${data.uptime}s`);
                        }
                    }
                    
                    if (data.rssi !== undefined) {
                        valorRssi.textContent = data.rssi;
                        const qualidade = obterQualidadeWifi(data.rssi);
                        qualidadeRssi.textContent = qualidade.text;
                        qualidadeRssi.className = `info-label ${qualidade.class}`;
                    }
                    
                    if (data.voltage !== undefined) {
                        valorVoltagem.textContent = data.voltage.toFixed(2);
                    }
                    
                    if (data.free_memory !== undefined && data.total_memory !== undefined) {
                        memoriaLivre.textContent = Math.round(data.free_memory / 1024);
                        memoriaTotal.textContent = Math.round(data.total_memory / 1024);
                        const uso = ((data.total_memory - data.free_memory) / data.total_memory) * 100;
                        usoMemoria.textContent = uso.toFixed(1);
                        barraUsoMemoria.style.width = uso + '%';
                        barraUsoMemoria.className = `progress-fill ${obterClasseUsoMemoria(uso)}`;
                    }
                    
                    if (data.uptime !== undefined) {
                        valorUptime.textContent = data.uptime;
                    }
                    
                    if (data.ip !== undefined) {
                        enderecoIp.textContent = data.ip;
                    }
                    
                } catch (e) {
                    adicionarEntradaLog(`📋 [${timestamp}] Mensagem: ${dados}`);
                    statusBotao.textContent = dados;
                    ultimaAtualizacao.textContent = timestamp;
                    
                    if (dados.includes("Pressionado")) {
                        statusBotao.className = 'status-value online';
                        visualBotao.classList.add('pressed');
                    } else {
                        statusBotao.className = 'status-value';
                        visualBotao.classList.remove('pressed');
                    }
                }
            } else if (topico === "esp32/heartbeat/unisenac") {
                processarBatimento(dados, timestamp);
            }
        }

        function forcarReconexao() {
            adicionarEntradaLog('🔄 Reconectando...');
            
            if (cliente && cliente.isConnected()) {
                cliente.disconnect();
            }
            
            tentativasBroker = 0;
            conectado = false;
            statusMqtt.textContent = 'Reconectando...';
            statusMqtt.className = 'status-value blink';
            
            setTimeout(() => iniciarMqtt(), 1000);
        }

        window.addEventListener('load', function() {
            adicionarEntradaLog('🚀 Sistema UniSENAC IoT iniciado');
            
            aguardarLibraryMQTT().then((nomeLibrary) => {
                adicionarEntradaLog(`✅ MQTT carregado: ${nomeLibrary}`);
                setTimeout(() => iniciarMqtt(), 1000);
            }).catch((erro) => {
                adicionarEntradaLog(`❌ Erro MQTT: ${erro}`);
            });
        });
    </script>
</body>
</html>

